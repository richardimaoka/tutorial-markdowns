---
title: "コピペで学ぶチュートリアル: サーバー待ちのローディング表示をApollo Client + Reactで行う"
emoji: "🐷"
type: "tech" # tech: 技術記事 / idea: アイデアh" # tech: 技術記事 / idea: アイデア
topics: ["GraphQL"]
published: false
---

## 導入

Apollo Client で構築したアプリケーションで、 GraphQL サーバーからの応答待ちの間に、いわゆる「スピナー」などのローディング表示を行いたい場合があります。

https://youtu.be/6ZIySVuxsCU

そこで本記事では Apollo Client の API に沿った形で、ローディング表示を React コンポーネントとして実装する方法を紹介します。手を動かして動作確認できると理解がしやすいかと思い、コピペだけで簡単に学べるチュートリアルにしています。

:::details React Suspense は使わないの？
ローディング表示を行いたい場合、React 18 以降では[Suspense](https://reactjs.org/blog/2022/03/29/react-v18.html#suspense-in-data-frameworks)が選択肢に上がるでしょう。ところが、[GitHub: apollo-client - Adding React suspense + data fetching support](https://github.com/apollographql/apollo-client/issues/9627)にあるように、Apollo Client 公式ではまだ Suspense との統合方法を紹介していません。

Apollo Client 公式が推奨する方法が決まるまでは、本記事のように Suspense を使わない従来のローディング表示が参考になると思います。
:::

## 事前準備

チュートリアルで作成するアプリケーション全体の構成はこちらです。

![apollo-client-loading-architecture](/images/26a9ec78c43463/apollo-client-loading-architecture.png)

こちらの構成を作っていきましょう。

### 事前準備 1. 作業ディレクトリ

まずは本チュートリアル用のディレクトリを作成します。

```sh:以下のコマンドを実行してください
mkdir tutorial-apollo-client-loadin。
cd tutorial-apollo-client-loading
```

全体のディレクトリ構成は最終的に以下のようになります。

```:ディレクトリ構成
tutorial-apollo-client-loading
  +- server  # Apollo GraphQL Server
  +- client  # React Client
```

それでは次の手順で、上記のディレクトリ構成のうち、`server`ディレクトリから作成していきましょう。

### 事前準備 2. GraphQL サーバー

GraphQL サーバーを準備します。

```sh:以下のコマンドを実行してください
# 一度に全部コピペで実行できます
mkdir server
cd server

# node.js setup
npm init -y
echo "node_modules" > .gitignore
```

TypeScript を導入して、ts-node-dev でサーバープロセスを立ち上げる準備をしましょう。

```sh:以下のコマンドを実行してください
# install and initialize typescript
npm install --save-dev typescript
npx tsc --init

# ts-node-dev: watch and restart a TypeScript server
npm install --save-dev ts-node-dev
npm pkg set scripts.start="ts-node-dev --watch src/*,data/*,./schema.gql --respawn src/index.ts"
```

Apollo Server と GraphQL Codegen を導入します。

```sh:以下のコマンドを実行してください
# apollo server
npm install apollo-server graphql

# install and setup graphql-codegen
npm install --save-dev @graphql-codegen/cli

# ここで npx graphql-code-generator init を行わず、後でcodegen.tsを生成。理由は後述。
npm install --save-dev \
  @graphql-codegen/typescript \
  @graphql-codegen/typescript-resolvers

npm pkg set scripts.generate="graphql-codegen --config codegen.yml --watch ./schema.gql,./data/*" # update generate script
```

`@graphql-codegen/cli`をインストールした後、通常はコマンド`npx graphql-code-generator init`によってファイル`codegen.ts`を生成しますが、そうすると対話モードに入ってしまい手入力が増えるのと、結局は生成された config.ts を上書き変更することになるので、以下のコマンドで config.ts を作成します。

```ts
cat << EOF > codegen.ts;
import type { CodegenConfig } from "@graphql-codegen/cli";

const config: CodegenConfig = {
  overwrite: true,
  schema: "schema.gql",
  generates: {
    "src/generated/graphql.ts": {
      plugins: ["typescript", "typescript-resolvers"],
      config: {
        avoidOptionals: true,
      },
    },
  },
  hooks: {
    afterOneFileWrite: ["npx prettier --write"],
  },
};

export default config;
EOF;
```

```sh:以下のコマンドを実行してください
# 開発ワークスペースのルートディレクトリに移動
# こうしないと、次のgit applyが静かに失敗する可能性あり
cd ../

curl https://github.com/richardimaoka/tutorial-apollo-client-loading/commit/65243e4ea244df1fd0bac1aeda9030643278e16c.patch \
  | git apply -v -
```

### 事前準備 3. React クライアント

```sh:以下のコマンドを実行してください
npx create-react-app client --template typescript

cd client
npx prettier --write .
```

```sh:以下のコマンドを実行してください
# apollo client
npm install @apollo/client graphql

# install and setup graphql-codegen
npm install --save-dev @graphql-codegen/cli

# ここで npx graphql-code-generator init を行わず、後でcodegen.tsを生成。理由は後述。
npm install --save-dev \
  @graphql-codegen/typescript-operations \
  @graphql-codegen/typescript \
  @graphql-codegen/typescript-react-apollo

npm pkg set scripts.codegen="graphql-codegen --config codegen.ts --watch src/\\*_/_.tsx,../server/schema.gql"
```

`@graphql-codegen/cli`をインストールした後、通常はコマンド`npx graphql-code-generator init`によってファイル`codegen.ts`を生成しますが、そうすると対話モードに入ってしまい手入力が増えるのと、結局は生成された config.ts を上書き変更することになるので、以下のコマンドで config.ts を作成します。

```ts:以下のコマンドを実行してください
cat << EOF > codegen.ts
import type { CodegenConfig } from "@graphql-codegen/cli";

const config: CodegenConfig = {
  overwrite: true,
  schema: "../server/schema.gql",
  documents: "src/**/*.tsx",
  generates: {
    "src/generated/graphql.ts": {
      plugins: [
        "typescript",
        "typescript-operations",
        "typescript-react-apollo",
      ],
      config: {
        avoidOptionals: true,
      },
    },
  },
  hooks: {
    afterOneFileWrite: ["npx prettier --write"],
  },
};

export default config;
EOF
```

続いて、後ほどスピナーを表示するのに利用する FontAwesome も導入しましょう。[公式ドキュメントの React 用セットアップ手順](https://fontawesome.com/docs/web/use-with/react/)に従って以下を実行します。

```sh:以下のコマンドを実行してください
# Add SVG Core
npm i --save @fortawesome/fontawesome-svg-core

# Add Icon Packages
npm i --save @fortawesome/free-solid-svg-icons
npm i --save @fortawesome/free-regular-svg-icons

# Add the React Component
npm i --save @fortawesome/react-fontawesome@latest
```

```sh:以下のコマンドを実行してください
# 開発ワークスペースのルートディレクトリに移動
# こうしないと、次のgit applyが静かに失敗する可能性あり
cd ../

curl https://github.com/richardimaoka/tutorial-apollo-client-loading/commit/aba557674d984551b8533d5b5b6cdd10109d9ae7.patch \
  | git apply -v -
```

## プロセス立ち上げ

4 つのプロセスを立ち上げます

![terminals](/images/26a9ec78c43463/terminals.png)

```sh:以下のコマンドを実行してください
cd server
npm run codegen
```

```sh:以下のコマンドを実行してください
cd server
npm start
```

```sh:以下のコマンドを実行してください
cd client
npm run codegen
```

```sh:以下のコマンドを実行してください
cd client
npm start
```

## 遅延のない場合のアプリケーション

ローディング表示を作る前に、遅延のない場合のサーバーサイドからのデータ表示を行いましょう。ごく簡単な人物プロフィールを 3 人分表示してみます。

![faces](/images/26a9ec78c43463/faces.png)

```sh:
command...
```

## 遅延がある場合のローディング表示

いよいよローディング表示です。

### サーバーサイドに遅延を挿入

```sh:
command...
```

```ts:
search: async (_parent, _args, context, _info) => {
  console.log("waiting started");
  await setTimeout(3000, null);
  console.log("waiting ended");
  return context.Query.search;
},
```

Apollo Studio からためす

![placeholder](/images/26a9ec78c43463/placeholder.png)

```gql
query {
}
```

animated GIF

![placeholder](/images/26a9ec78c43463/placeholder.png)

### クライアントサイドにローディング表示を導入

```sh:
command...
```

```ts:
if (loading) {
  return (
    <div>
      <FontAwesomeIcon icon={faSpinner} size={"4x"} spin={true} />
    </div>
  );
}
```

![spinner](/images/26a9ec78c43463/Spinner.gif)
