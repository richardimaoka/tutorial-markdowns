---
title: "コピペで学ぶチュートリアル: サーバー待ちのローディング表示をApollo Client + Reactで行う"
emoji: "🐷"
type: "tech" # tech: 技術記事 / idea: アイデアh" # tech: 技術記事 / idea: アイデア
topics: ["GraphQL"]
published: false
---

## 導入

Apollo Client で構築したアプリケーションで、 GraphQL サーバーからの応答待ちの間に、いわゆる「スピナー」などのローディング表示を行いたい場合があります。

![spinner](/images/26a9ec78c43463/Spinner.gif)

そこで本記事では Apollo Client の API に沿った形で、ローディング表示を React コンポーネントとして実装する方法を紹介します。手を動かして動作確認できると理解がしやすいかと思い、コピペだけで簡単に学べるチュートリアルにしています。

:::details React Suspense は使わないの？
ローディング表示を行いたい場合、React 18 以降では[Suspense](https://reactjs.org/blog/2022/03/29/react-v18.html#suspense-in-data-frameworks)が選択肢に上がるでしょう。ところが、[GitHub: apollo-client - Adding React suspense + data fetching support](https://github.com/apollographql/apollo-client/issues/9627)にあるように、Apollo Client 公式ではまだ Suspense との統合方法を紹介していません。

Apollo Client 公式が推奨する方法が決まるまでは、本記事のように Suspense を使わない従来のローディング表示が参考になると思います。
:::

## 事前準備

チュートリアルで作成するアプリケーション全体の構成はこちらです。

![placeholder](/images/26a9ec78c43463/placeholder.png)

こちらの構成を作っていきましょう。

### 事前準備 1. 作業ディレクトリ

まずは本チュートリアル用のディレクトリを作成します。

```sh:以下のコマンドを実行してください
mkdir tutorial-apollo-client-loadin。
cd tutorial-apollo-client-loading
```

全体のディレクトリ構成は最終的に以下のようになります。

```:ディレクトリ構成
tutorial-apollo-client-loading
  +- server  # GraphQL Server
  +- client  # React Client
```

それでは次の手順で、上記のディレクトリ構成のうち、`server`ディレクトリから作成していきましょう。

### 事前準備 2. GraphQL サーバー

まずは GraphQL サーバーを準備します。

```sh:以下のコマンドを実行してください
# 一度に全部コピペで実行できます

mkdir server
cd server

# node.js setup
npm init -y
echo "node_modules" > .gitignore

# install and initialize typescript
npm install --save-dev typescript
npx tsc --init

# ts-node-dev: watch and restart a TypeScript server
npm install --save-dev ts-node-dev
npm pkg set scripts.start="ts-node-dev --watch src/* --respawn src/index.ts"

# apollo server
npm install apollo-server graphql

# install and setup graphql-codegen
npm install --save-dev @graphql-codegen/cli
# ここで npx graphql-code-generator init を行ってもよいが、そうすると対話モードに入って手入力が増えるのと、
# 結局は npx graphql-code-generator init で生成されたconfig.ymlを上書き更新することになるので、以下はnpm installのみ行って config.ymlは後ほど作成
npm install --save-dev  @graphql-codegen/typescript @graphql-codegen/typescript-resolvers
npm pkg set scripts.generate="graphql-codegen --config codegen.yml --watch ./schema.gql" # update generate script

# copy files
mkdir src
mkdir data
curl https://raw.githubusercontent.com/richardimaoka/tutorial-apollo-server-setup/main/server/codegen.yml > codegen.yml
curl https://raw.githubusercontent.com/richardimaoka/tutorial-apollo-server-setup/main/server/schema.gql > schema.gql
curl https://raw.githubusercontent.com/richardimaoka/tutorial-apollo-server-setup/main/server/src/index.ts > src/index.ts
curl https://raw.githubusercontent.com/richardimaoka/tutorial-apollo-server-setup/main/server/data/Query.json > data/Query.json

# tutorial-apollo-client-loading ディレクトリに戻る
cd ../
```

### 事前準備 3. React クライアント

```sh:以下のコマンドを実行してください
# 一度に全部コピペで実行できます

mkdir server
cd server

# node.js setup
npm init -y
echo "node_modules" > .gitignore

# install and initialize typescript
npm install --save-dev typescript
npx tsc --init

# ts-node-dev: watch and restart a TypeScript server
npm install --save-dev ts-node-dev
npm pkg set scripts.start="ts-node-dev --watch src/* --respawn src/index.ts"

# apollo server
npm install apollo-server graphql

# install and setup graphql-codegen
npm install --save-dev @graphql-codegen/cli
# ここで npx graphql-code-generator init を行ってもよいが、そうすると対話モードに入って手入力が増えるのと、
# 結局は npx graphql-code-generator init で生成されたconfig.ymlを上書き更新することになるので、以下はnpm installのみ行って config.ymlは後ほど作成
npm install --save-dev  @graphql-codegen/typescript @graphql-codegen/typescript-resolvers
npm pkg set scripts.generate="graphql-codegen --config codegen.yml --watch ./schema.gql" # update generate script

# copy files
mkdir src
mkdir data
curl https://raw.githubusercontent.com/richardimaoka/tutorial-react-graphql-setup/a61745c7a63580df65a911734f423f673c390261/server/codegen.yml > codegen.yml
curl https://raw.githubusercontent.com/richardimaoka/tutorial-react-graphql-setup/a61745c7a63580df65a911734f423f673c390261/server/schema.gql > schema.gql
curl https://raw.githubusercontent.com/richardimaoka/tutorial-react-graphql-setup/a61745c7a63580df65a911734f423f673c390261/server/src/index.ts > src/index.ts
curl https://raw.githubusercontent.com/richardimaoka/tutorial-react-graphql-setup/a61745c7a63580df65a911734f423f673c390261/server/data/Query.json > data/Query.json

# tutorial-apollo-client-loading ディレクトリに戻る
cd ../
```

#### Font-awesome の導入

続いて、後ほどスピナーを表示するのに利用する FontAwesome も導入しましょう。[公式ドキュメントの React 用セットアップ手順](https://fontawesome.com/docs/web/use-with/react/)に従って以下を実行します。

```sh:以下のコマンドを実行してください
# Add SVG Core
npm i --save @fortawesome/fontawesome-svg-core

# Add Icon Packages
npm i --save @fortawesome/free-solid-svg-icons
npm i --save @fortawesome/free-regular-svg-icons

# Add the React Component
npm i --save @fortawesome/react-fontawesome@latest
```

## プロセス立ち上げ

4 つのプロセスを立ち上げます

![terminals](/images/26a9ec78c43463/terminals.png)

## 遅延のない場合のアプリケーション

ローディング表示を作る前に、遅延のない場合のサーバーサイドからのデータ表示を行いましょう。ごく簡単な人物プロフィールを 3 人分表示してみます。

![faces](/images/26a9ec78c43463/faces.png)

```sh:
command...
```

## 遅延がある場合のローディング表示

いよいよローディング表示です。

### サーバーサイドに遅延を挿入

```sh:
command...
```

```ts:
diff
```

![placeholder](/images/26a9ec78c43463/placeholder.png)

### クライアントサイドにローディング表示を導入

```sh:
command...
```

```ts:
diff
```

![spinner](/images/26a9ec78c43463/Spinner.gif)
