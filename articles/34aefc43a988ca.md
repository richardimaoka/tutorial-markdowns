---
title: "コピペで学ぶチュートリアル: GitHub Pull Request の merge conflict 解決手法を試す"
emoji: "🐷"
type: "tech" # tech: 技術記事 / idea: アイデア
topics: ["git"]
published: false
---

## 導入

GitHub の pull request で [merge conflict が発生した際](https://docs.github.com/ja/pull-requests/collaborating-with-pull-requests/addressing-merge-conflicts/about-merge-conflicts)、その解決には 1.GitHub の Web UI 上で行うものと、2.ローカルのコンピュータで行うものがあります。

1. [GitHub 公式: GitHub でのマージ コンフリクトを解決する](https://docs.github.com/ja/pull-requests/collaborating-with-pull-requests/addressing-merge-conflicts/resolving-a-merge-conflict-on-github)
2. [GitHub 公式: コマンド ラインを使用してマージ コンフリクトを解決する](https://docs.github.com/ja/pull-requests/collaborating-with-pull-requests/addressing-merge-conflicts/resolving-a-merge-conflict-using-the-command-line)

解決手法の違いについて手を動かして動作確認すると、知識の整理もできると思いますので、本記事ではコピペで貼り付けるだけで簡単に手順を再現できるようにしています。

:::details merge conflict がない場合の update 手法との区別

本記事で対象とするのは pull request で merge conflict を解決する手法なので、merge conflict が発生していないときに pull request update する手法とは区別してください。後者については以下を参考にしてください。

- [GitHub 公式: ベース ブランチと pull request の同期の維持](https://docs.github.com/ja/pull-requests/collaborating-with-pull-requests/proposing-changes-to-your-work-with-pull-requests/keeping-your-pull-request-in-sync-with-the-base-branch)
- [GitHub 公式 blog: More ways to keep your pull request branch up-to-date](https://github.blog/changelog/2022-02-03-more-ways-to-keep-your-pull-request-branch-up-to-date/)
- [コピペで学ぶチュートリアル: GitHub Pull Request の update 手法を試す](./6c36be1256c4fa)

:::

:::details pull request のマージ手法との区別

本記事で対象とするのは pull request『内』で merge conflict を解決する手法なので、pull request 自体を base ブランチへと merge する手法とは区別してください。後者については以下を参考にしてください。

- [GitHub 公式: コマンド ラインを使用してマージ コンフリクトを解決する](https://docs.github.com/ja/pull-requests/collaborating-with-pull-requests/incorporating-changes-from-a-pull-request/about-pull-request-merges)
- [コピペで学ぶチュートリアル: GitHub Pull Request 3 種類の merge 手法を試す](./f20aee8979292d)

:::

## 準備: GitHub レポジトリの作成

まずはローカル環境で git レポジトリを作成します。

```sh:コピペして実行
mkdir pull-req-conflict-experiments
cd pull-req-conflict-experiments
git init
```

GitHub 上にレポジトリを作成しましょう。Web ブラウザではなくコマンドを使えば一発で終わります。

```sh:コピペして実行
gh repo create pull-req-conflict-experiments --public --source=. --remote=origin
```

:::details 　上記の gh コマンドは何？
[gh コマンド(GitHub CLI)](https://cli.github.com/)を使えば、GitHub 上でのリポジトリ作成など作業をローカルからコマンドひとつで行えます。まだインストールしていない方は、ぜひインストールを検討してください。[gh repo create サブコマンドの説明](https://cli.github.com/manual/gh_repo_create)にもありますが、上記のコマンドのオプションと引数の意味はこちらです。

- `pull-req-udpate-experiments`: GitHub 上のレポジトリ名
- `--public`: public レポジトリとして作成
- `--source=.`: ローカルレポジトリのパスはカレントディレクトリ `.`
- `--remote=origin` リモートレポジトリを origin に指定

:::

## Merge conflict が発生しない場合

本記事は merge conflict 解決手法の動作確認が目的ですが、対比のためにまずは merge conflict が発生しない場合を見ていきましょう。

```sh:コピペして実行
cat << EOF > experiment1.txt
a

b

c
EOF
git add --all
git commit -m "create experiment1.txt"
git push origin main
```

ファイルの内容はこちらです。

```txt:experiment1.txt
a

b

c
```

次に、pull request を作成します。

```sh:コピペして実行
git switch -c pr-1

sed -i 's/a/aaaaa/' experiment1.txt # ファイル中のaをaaaaaに置き換え
git add --all
git commit -m "update a in pr-1"

git push --set-upstream origin pr-1
gh pr create --title pr-1 --body "" --base main --head pr-1
```

base ブランチに直接変更を加え、push しましょう。

```sh:コピペして実行
git switch main

# merge conflict が発生しないよう、`pr-1`とは別のファイル行を変更しています。
sed -i 's/b/bbbbb/' experiment1.txt # ファイル中のbをbbbbbに置き換え
git add --all
git commit -m "update b in main"

git push origin main
```

:::details base ブランチの push が pull request の file diff に反映されない？

base ブランチの変更を push しただけでは、pull request の file diff は更新されません。下画像のように、3 行目が`b`1 文字のままであることがわかります。

![pr-file-diff-1a](/images/6c36be1256c4fa/pr-file-diff-1a.png)

これは、GitHub では pull request の file diff は base ブランチの変更を取り込まないようになっているからです。base ブランチの変更を取り込むには、別記事「[コピペで学ぶチュートリアル: GitHub Pull Request の update 手法 2 種類を試す](./6c36be1256c4fa)」の解説している update(rebase) branch の操作が必要です。

:::

Pull request を見ると`This branch has no conflicts with the base branch`と表示されているので、Merge pull request ボタンを押しましょう。

![merge pull request button](/images/34aefc43a988ca/merge-pull-request-button.png)

:::details ターミナルから pull request をマージしたい場合

```sh:コピペして実行
gh pr merge pr-1 --merge --delete-branch
```

:::

## Merge conflict を GitHub UI 上で解決 (同一ファイルの同一行での conflict)

変更対象のテキストファイル experiment2.txt を作成します。

```sh:コピペして実行
cat << EOF > experiment2.txt
a

b

c
EOF
git add --all
git commit -m "create experiment2.txt"
git push origin main
```

ファイルの内容はこちらです。

```txt:experiment2.txt
a

b

c
```

Pull request を作成します。

```sh:コピペして実行
git switch -c pr-2

sed -i 's/a/aaaaa/' experiment2.txt # ファイル中のaをaaaaaに置き換え
git add --all
git commit -m "update a in pr-2"

git push --set-upstream origin pr-2
gh pr create --title pr-2 --body "" --base main --head pr-2
```

base ブランチに直接変更を加え、push しましょう。

```sh:コピペして実行
git switch main

# わざとmerge conflict が発生するよう、`pr-2`と同一のファイル行を変更しています
sed -i 's/a/aaa/' experiment2.txt # ファイル中のaをaaaに置き換え
git add --all
git commit -m "update b in main"

git push origin main
```

Pull request を見ると merge conflict が発生し、Merge pull requst ボタンは押せなくなっています。代わりに Resolve conflicts ボタンを押しましょう。

![merge conflict](/images/34aefc43a988ca/merge-conflict.png)

このような画面が表示されるので、merge conflict を解決していきます。

![resolve conflict 1](/images/34aefc43a988ca/resolve-conflict1.png)

`<<<<<<<` と `=======` と `>>>>>>>` を消せば、右上の Mark as resolved ボタンが押せるようになります。

![resolve conflict 2](/images/34aefc43a988ca/resolve-conflict2.png)

続いて、Commit merge ボタンを押しましょう。

![resolve conflict 3](/images/34aefc43a988ca/resolve-conflict3.png)

Resolve conflicts が完了すると、`Merge branch 'main' into pr-2` と pull request の Commits に表示されています。

![pr git log 1](/images/34aefc43a988ca/pr-git-log1.png)

Pull request を見ると`This branch has no conflicts with the base branch`と表示されているので、Merge pull request ボタンを押しましょう。

![merge pull request button](/images/34aefc43a988ca/merge-pull-request-button.png)

:::details ターミナルから pull request をマージしたい場合

```sh:コピペして実行
gh pr merge pr-1 --merge --delete-branch
```

:::

![main git log](/images/34aefc43a988ca/main-git-log-1.png)

## 同一ファイルの更新 vs. 削除の conflict

### 同一ファイルの同一行での conflict
