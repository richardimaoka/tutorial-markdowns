---
title: "コピペで学ぶチュートリアル: GitHub Pull Request 3種類のmerge手法を試す"
emoji: "🐷"
type: "tech" # tech: 技術記事 / idea: アイデア
topics: ["git"]
published: false
---

## 導入

GitHub の Pull Request をマージする方法には 3 種類の方法、Merge pull request(Create a merge commit)、Squash and merge、Rebase and merge があります。

![Create a merge commit](/images/f20aee8979292d/pr-merge-merge-commit.png)

:::details それぞれの違いについては公式ドキュメントでも、Qiita などでも解説されています。

- GitHub Docs (公式):

  - [プルリクエストのマージについて](https://docs.github.com/ja/pull-requests/collaborating-with-pull-requests/incorporating-changes-from-a-pull-request/about-pull-request-merges)
  - [プルリクエストをマージする](https://docs.github.com/ja/pull-requests/collaborating-with-pull-requests/incorporating-changes-from-a-pull-request/merging-a-pull-request)

- Qiita:

  - [ Github での Web 上からのマージの仕方 3 種とその使いどころ](https://qiita.com/ko-he-8/items/94e872f2154829c868df)

:::

すでに様々な場所で解説されている内容ですが、あらためて自分で手を動かして動作確認すると、知識の整理ができると思います。

それでは、ここからはコマンドをコピペで貼り付けて再現できる形で、動作確認の手順を説明していきます。

## GitHub レポジトリの作成

まずはローカル環境で git レポジトリを作成します。

```sh:コピペして実行
mkdir pull-req-merge-experiments
cd pull-req-merge-experiments
git init
```

GitHub 上にレポジトリを作成しましょう。Web ブラウザではなくコマンドを使えば一発で終わります。

```sh:コピペして実行
gh repo create "" --public --source=. --remote=origin
```

:::details 　上記の gh コマンドは何？
[gh コマンド(GitHub CLI)](https://cli.github.com/)を使えば、GitHub 上でのリポジトリ作成など作業をローカルからコマンドひとつで行えます。まだインストールしていない方は、ぜひインストールを検討してください。[gh repo create サブコマンドの説明はこちら](https://cli.github.com/manual/gh_repo_create)。
:::

## Merge pull request(Create a merge commit)

まずは 3 種類のマージ手法のうち、Merge commit から説明します。

![Create a merge commit](/images/f20aee8979292d/pr-merge-merge-commit.png)

まずは最初のコミットで編集対象のファイル `pull-req-merge-commit.txt`を作成します。

```sh:コピペして実行 (全部一度にコピペできます)
cat << EOF > pull-req-merge-commit.txt
a

b

c
EOF
git add --all
git commit -m "create pull-req-merge-commit.txt"
git push origin main
```

1 つめの Pull Request を作成しましょう。

```sh:コピペして実行
git switch -c pr-merge-commit-1
sed -i 's/a/aaaaa/' pull-req-merge-commit.txt
git add --all
git commit -m "update a in pr-merge-commit-1"

# GitHubにPull Requestを作成
git push --set-upstream origin pr-merge-commit-1
gh pr create --title pr-merge-commit-1 --body "" --base main --head pr-merge-commit-1
```

:::details Pull Request の File diff
![branch-merge-commit-1](/images/f20aee8979292d/branch-merge-commit-1.png)
:::

次に 1 つめの Pull Request と[コンフリクト](https://docs.github.com/ja/pull-requests/collaborating-with-pull-requests/addressing-merge-conflicts/about-merge-conflicts)を起こさないように 2 つめの Pull Request を作成します。

```sh:コピペして実行
git switch -c pr-merge-commit-2 main
sed -i 's/b/bbbbb/' pull-req-merge-commit.txt
git add --all
git commit -m "update b in pr-merge-commit-2"
sed -i 's/c/ccccc/' pull-req-merge-commit.txt
git add --all
git commit -m "update c in pr-merge-commit-2"

# GitHubにPull Requestを作成
git push --set-upstream origin pr-merge-commit-2
gh pr create --title pr-merge-commit-2 --body "" --base main --head pr-merge-commit-2
```

:::details Pull Request の File diff
![branch-merge-commit-2](/images/f20aee8979292d/branch-merge-commit-2.png)
:::

これで merge commit の動作を確認するための Pull Request が 2 つ作成されました。まずは最初の Pull Request をマージします。

```sh:コピペして実行
gh pr merge pr-merge-commit-1 --merge --delete-branch
```

:::details 1 つめの Pull Request マージ結果
これによって Merge commit が作成されます。

![github-log-merge-commit-1](/images/f20aee8979292d/github-log-merge-commit-1.png)

Merge commit の File diff は、1 つ目のブランチの直前のコミットの File diff と同じ内容です。

![git-pr-merge-5.png](/images/f20aee8979292d/git-pr-merge-5.png)

続いて 2 つめの Pull Request をマージします。

:::

```sh:コピペして実行
gh pr merge pr-merge-commit-2 --merge --delete-branch
```

:::details 2 つめの Pull Request マージ結果
これによって Merge commit が作成されます。

![github-log-merge-commit-2](/images/f20aee8979292d/github-log-merge-commit-2.png)

Merge commit の File diff は、2 つ目のブランチの全てのコミットの File diff を合わせた内容です。

![git-pr-merge-6.png](/images/f20aee8979292d/git-pr-merge-6.png)
:::

GitHub 側で更新された main ブランチを pull しましょう。

```sh:コピペして実行
git switch main
git pull origin main
```

:::details git log の確認

GitHub 上でここまでの git log を確認すると、一直線にコミットが並んでいて、かつ Merge commit2 つが連続しているようにみえてしまいます。

![github-log-merge-commit](/images/f20aee8979292d/github-log-merge-commit.png)

Merge commit によって分岐が発生した場合には、下記のコマンドで確認すると分岐の様子がわかりやすくなります。

```sh:コピペして実行
git log --oneline --decorate --graph
```

```txt:実行結果
*   012ef98 Merge pull request #2 from richardimaoka/pr-merge-commit-2
|\
| * 30d1b5b update 3 in pr-merge-commit-2
| * 474cc81 update 2 in pr-merge-commit-2
* |   4f7c52c Merge pull request #1 from richardimaoka/pr-merge-commit-1
|\ \
| |/
|/|
| * 93924f6 update 1 in pr-merge-commit-1
|/
* 5ae629f create pull-req-merge-commit.txt
```

:::

## fast-forward merge locally

:::details (create a merge commit では) プルリクエストは --no-ff オプションを使用してマージされますが…

### fast-forward merge locally

```shell
touch local-ff.txt
git add --all
git commit -m "create local-ff.txt"

git switch -c local-ff-1
echo a > local-ff.txt
git add --all
git commit -m "add a in branch local-ff-1"
echo b >> local-ff.txt
git add --all
git commit -m "add b in branch local-ff-1"
```

![altテキスト](/images/f20aee8979292d/git-pr-merge-1.png)

```shell
git switch main
git merge local-ff-1
git branch -d local-ff-1

git push origin main
```

![altテキスト](/images/f20aee8979292d/git-pr-merge-2.png)

### no-ff merge locally

```shell
touch local-no-ff.txt
git add --all
git commit -m "create local-no-ff.txt"

git switch -c local-no-ff-1
echo a > local-no-ff.txt
git add --all
git commit -m "add a in branch local-no-ff-1"
echo b >> local-no-ff.txt
git add --all
git commit -m "add b in branch local-no-ff-1"

git switch main
git merge --no-ff --no-edit local-no-ff-1
git branch -d local-no-ff-1

git push origin main
```

![altテキスト](/images/f20aee8979292d/git-pr-merge-3.png)

:::

## Squash and merge

```shell
cat << EOF > pull-req-squash-merge.txt
a

b

c
EOF
git add --all
git commit -m "create pull-req-squash-merge.txt"
git push origin main

git switch -c pr-squash-merge-1
sed -i 's/a/aaaaa/' pull-req-squash-merge.txt
git add --all
git commit -m "update a in pr-squash-merge-1"
git push --set-upstream origin pr-squash-merge-1

git switch -c pr-squash-merge-2 main
sed -i 's/b/bbbbb/' pull-req-squash-merge.txt
git add --all
git commit -m "update b in pr-squash-merge-2"
sed -i 's/c/ccccc/' pull-req-squash-merge.txt
git add --all
git commit -m "update c in pr-squash-merge-2"
git push --set-upstream origin pr-squash-merge-2

gh pr create --title pr-squash-merge-1 --body "" --base main --head pr-squash-merge-1
gh pr create --title pr-squash-merge-2 --body "" --base main --head pr-squash-merge-2
gh pr merge pr-squash-merge-1 --squash --delete-branch # PRのSquash merge
gh pr merge pr-squash-merge-2 --squash --delete-branch # PRのSquash merge

git switch main
git pull origin main
```

![altテキスト](/images/f20aee8979292d/git-pr-merge-7.png)

![altテキスト](/images/f20aee8979292d/git-pr-merge-8.png)

```shell
git log --oneline --decorate --graph
```

## Rebase and merge

```shell
cat << EOF > pull-req-rebase-merge.txt
a

b

c
EOF
git add --all
git commit -m "create pull-req-rebase-merge.txt"
git push origin main

git switch -c pr-rebase-merge-1
sed -i 's/a/aaaaa/' pull-req-rebase-merge.txt
git add --all
git commit -m "update a in pr-rebase-merge-1"
git push --set-upstream origin pr-rebase-merge-1

git switch -c pr-rebase-merge-2 main
sed -i 's/b/bbbbb/' pull-req-rebase-merge.txt
git add --all
git commit -m "update b in pr-rebase-merge-2"
sed -i 's/c/ccccc/' pull-req-rebase-merge.txt
git add --all
git commit -m "update c in pr-rebase-merge-2"
git push --set-upstream origin pr-rebase-merge-2

gh pr create --title pr-rebase-merge-1 --body "" --base main --head pr-rebase-merge-1
gh pr create --title pr-rebase-merge-2 --body "" --base main --head pr-rebase-merge-2
gh pr merge pr-rebase-merge-1 --rebase --delete-branch
gh pr merge pr-rebase-merge-2 --rebase --delete-branch

git switch main
git pull origin main
git branch -D pr-rebase-merge-1
git branch -D pr-rebase-merge-2

git log --oneline --decorate --graph
```
